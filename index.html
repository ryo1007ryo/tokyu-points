<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±æ€¥ãƒã‚¤ãƒ³ãƒˆæ¯”è¼ƒ & è·é›¢æ¤œç´¢</title>
    <style>
        :root { --tokyu-red: #e60012; --bg-color: #f4f7f6; }
        body { font-family: -apple-system, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; background-color: var(--bg-color); }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h1 { color: var(--tokyu-red); font-size: 1.4rem; text-align: center; margin-top: 0; }
        .status { font-size: 0.75rem; color: #888; text-align: center; margin-bottom: 15px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 0.9rem; }
        input[type="number"], select, input[type="date"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        
        .result-item { background: white; padding: 16px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid transparent; }
        .result-item.rank-1 { border-left-color: #ffd700; }
        
        .header-row { display: flex; justify-content: space-between; align-items: flex-start; }
        .facility-name { font-size: 1.1rem; font-weight: bold; }
        .distance-info { font-size: 0.8rem; color: #666; margin-left: 5px; }
        .total-points { text-align: right; }
        .total-val { font-size: 1.5rem; font-weight: bold; color: var(--tokyu-red); }
        
        .campaign-list { margin: 8px 0; display: flex; flex-wrap: wrap; gap: 4px; }
        .badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; font-weight: bold; }
        .badge-campaign { background: #fff9c4; color: #856404; border: 1px solid #ffe082; }
        .badge-entry { background: #ff7043; color: white; }
        
        .breakdown { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: #fcfcfc; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; color: #666; border: 1px inset #f0f0f0; }
        .rate-info { font-size: 0.75rem; color: #999; text-align: right; margin-top: 4px; }
        
        .location-btn { background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; width: 100%; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <h1>æ±æ€¥ãƒã‚¤ãƒ³ãƒˆæ¯”è¼ƒ</h1>
        <div id="status" class="status">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        
        <button class="location-btn" onclick="requestLocation()">ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦è·é›¢ã‚’è¡¨ç¤º</button>

        <div class="input-group">
            <label>è³¼å…¥äºˆå®šé‡‘é¡ (å††)</label>
            <input type="number" id="amount" value="10000" oninput="update()">
        </div>
        <div class="input-group">
            <label>æ”¯æ‰•ã„æ–¹æ³•</label>
            <select id="paymentMethod" onchange="update()">
                <option value="cash">ç¾é‡‘æ‰•ã„ (é€šå¸¸1.0%)</option>
                <option value="other_credit">ä»–ç¤¾ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æ‰•ã„ (é€šå¸¸1.0%)</option>
                <option value="tokyu_card" selected>TOKYU CARDæ‰•ã„</option>
                <option value="tokyu_smart">TOKYU CARDã‚¹ãƒãƒ¼ãƒˆæ‰•ã„</option>
            </select>
        </div>
        <div class="input-group">
            <label>æ—¥ä»˜</label>
            <input type="date" id="targetDate" onchange="update()">
        </div>
    </div>

    <div id="results"></div>

    <script>
        const URL_FACILITIES = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTgbOaI1waBfqiOLvukQaRkPq4ngqEbffAUjjc72sfj_c_UODSXsozYwQ2ijZ-pUd2lem3MVibhxFVW/pub?output=csv';
        const URL_CAMPAIGNS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRzO3NLasGVUK3k_AZDIJh62INF72AZO1mECDFgflxq3ke0QQ0jiwjN7JJHX9b65rrwnxsVU-RySVgk/pub?output=csv';

        let masterFacilities = [];
        let masterCampaigns = [];
        let userLocation = null;

        document.getElementById('targetDate').valueAsDate = new Date();

        async function init() {
            try {
                const [resFac, resCam] = await Promise.all([ fetch(URL_FACILITIES), fetch(URL_CAMPAIGNS) ]);
                const textFac = await resFac.text();
                const textCam = await resCam.text();

                masterFacilities = textFac.split('\n').slice(1).filter(r => r.trim()).map(row => {
                    const c = row.split(',');
                    return { 
                        id: c[0].trim(), 
                        name: c[1].trim(), 
                        basic: parseFloat(c[2]) || 0, 
                        store: parseFloat(c[3]) || 0,
                        creditTokyu: parseFloat(c[4]) || 0,
                        creditSmart: parseFloat(c[5]) || 0,
                        lat: parseFloat(c[6]) || null, // ç·¯åº¦
                        lng: parseFloat(c[7]) || null  // çµŒåº¦
                    };
                });

                masterCampaigns = textCam.split('\n').slice(1).filter(r => r.trim()).map(row => {
                    const c = row.split(',');
                    return {
                        facilityId: c[0].trim(),
                        name: c[1].trim(),
                        start: new Date(c[2].trim()),
                        end: new Date(c[3].trim()),
                        additionalRate: parseFloat(c[4]) || 0,
                        requiresEntry: c[5]?.trim().toLowerCase() === 'true'
                    };
                });

                document.getElementById('status').innerText = 'æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ';
                update();
            } catch (e) {
                document.getElementById('status').innerText = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            }
        }

        function requestLocation() {
            if (!navigator.geolocation) {
                alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
                return;
            }
            navigator.geolocation.getCurrentPosition(pos => {
                userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                document.getElementById('status').innerText = 'ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¾ã—ãŸ';
                update();
            }, err => {
                alert("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
            });
        }

        // 2ç‚¹é–“ã®è·é›¢(km)ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
        function getDistance(lat1, lon1, lat2, lon2) {
            if (!lat1 || !lon1 || !lat2 || !lon2) return null;
            const R = 6371; // åœ°çƒã®åŠå¾„
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function update() {
            if (masterFacilities.length === 0) return;

            const amount = parseInt(document.getElementById('amount').value) || 0;
            const method = document.getElementById('paymentMethod').value;
            const selectedDate = new Date(document.getElementById('targetDate').value);
            selectedDate.setHours(0,0,0,0);

            const calculated = masterFacilities.map(f => {
                const activeCampaigns = masterCampaigns.filter(c => {
                    return c.facilityId === f.id && selectedDate >= c.start && selectedDate <= c.end;
                });
                
                const totalAdditionalRate = activeCampaigns.reduce((sum, c) => sum + c.additionalRate, 0);
                const isTokyuPayment = (method === 'tokyu_card' || method === 'tokyu_smart');
                const baseRate = isTokyuPayment ? f.store : f.basic;
                const immediateRate = baseRate + totalAdditionalRate;

                let creditRate = 0;
                if (method === 'tokyu_card') creditRate = f.creditTokyu;
                if (method === 'tokyu_smart') creditRate = f.creditSmart;

                const distance = userLocation ? getDistance(userLocation.lat, userLocation.lng, f.lat, f.lng) : null;

                return {
                    ...f,
                    totalPoints: Math.floor(amount * immediateRate) + Math.floor(amount * creditRate),
                    immediatePoints: Math.floor(amount * immediateRate),
                    creditPoints: Math.floor(amount * creditRate),
                    totalRate: ((immediateRate + creditRate) * 100).toFixed(1),
                    distance: distance,
                    activeCampaigns,
                    hasEntry: activeCampaigns.some(c => c.requiresEntry)
                };
            });

            // ã‚½ãƒ¼ãƒˆé †ï¼ˆè·é›¢ãŒã‚ã‹ã£ã¦ã„ã‚Œã°è·é›¢é †ã«ã—ãŸã„å ´åˆã¯ã“ã“ã‚’èª¿æ•´ï¼‰
            calculated.sort((a, b) => b.totalPoints - a.totalPoints);

            document.getElementById('results').innerHTML = calculated.map((f, index) => `
                <div class="result-item ${index === 0 ? 'rank-1' : ''}">
                    <div class="header-row">
                        <div>
                            <div class="facility-name">${f.name}
                                ${f.distance ? `<span class="distance-info">ğŸ“${f.distance.toFixed(1)}km</span>` : ''}
                            </div>
                            <div class="campaign-list">
                                ${f.activeCampaigns.map(c => `<span class="badge badge-campaign">${c.name} (+${(c.additionalRate*100).toFixed(0)}%)</span>`).join('')}
                                ${f.hasEntry ? '<span class="badge badge-entry">è¦ã‚¨ãƒ³ãƒˆãƒªãƒ¼</span>' : ''}
                            </div>
                        </div>
                        <div class="total-points">
                            <div class="total-val">${f.totalPoints.toLocaleString()}<small>pt</small></div>
                            <div class="rate-info">é‚„å…ƒç‡ ${f.totalRate}%</div>
                        </div>
                    </div>
                    <div class="breakdown">
                        <div>å³æ™‚ä»˜ä¸: ${f.immediatePoints.toLocaleString()}</div>
                        <div>å¾Œæ—¥åŠ ç®—: ${f.creditPoints.toLocaleString()}</div>
                    </div>
                </div>
            `).join('');
        }

        init();
    </script>
</body>
</html>
